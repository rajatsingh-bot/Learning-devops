pipeline {
    agent any

    environment {
        NODE_HOME = "C:\\Users\\Rajat Singh\\AppData\\Roaming\\npm"
        PATH = "${env.NODE_HOME};${env.PATH}"
        HUB_ORG_DH = credentials('HUB_ORG_DH')                     // Dev Hub username/email
        SFDC_HOST_DH = credentials('SFDC_HOST_DH')                 // e.g. https://login.salesforce.com
        CONNECTED_APP_CONSUMER_KEY_DH = credentials('CONNECTED_APP_CONSUMER_KEY_DH')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "‚úÖ Code checked out from GitHub ‚Äî branch: ${env.BRANCH_NAME}"
            }
        }

        stage('Login to Dev Hub') {
            steps {
                withCredentials([file(credentialsId: 'sfdc-jwt-key', variable: 'JWT_KEY')]) {
                    powershell """
                        sf org login jwt `
                            --client-id $env:CONNECTED_APP_CONSUMER_KEY_DH `
                            --username $env:HUB_ORG_DH `
                            --jwt-key-file "$env:JWT_KEY" `
                            --instance-url $env:SFDC_HOST_DH `
                            --alias DevHub `
                            --set-default-dev-hub
                    """
                    echo "‚úÖ Dev Hub login successful - alias set: DevHub"
                }
            }
        }

        stage('Create Scratch Org') {
            steps {
                powershell """
                    sf org create scratch `
                        --definition-file config/project-scratch-def.json `
                        --alias CI_SCRATCH `
                        --target-dev-hub DevHub `
                        --set-default `
                        --duration-days 1 `
                        --wait 10
                """
                echo "‚úÖ Scratch org created successfully - alias: CI_SCRATCH"
            }
        }

        stage('Deploy Code to Scratch Org') {
            steps {
                powershell 'sf project deploy start --manifest manifest/package.xml --target-org CI_SCRATCH --wait 60'
                echo "‚úÖ Code deployed to scratch org"
            }
        }

        stage('Run Apex Unit Tests') {
            steps {
                powershell 'sf apex run test --target-org CI_SCRATCH --test-level RunLocalTests --wait 20'
                echo "‚úÖ Apex unit tests executed"
            }
        }

        stage('Export Test Report') {
            steps {
                powershell 'sf apex run test report --target-org CI_SCRATCH --result-format junit --output-dir test-results'
                junit 'test-results/test-result-*.xml'
                echo "‚úÖ JUnit test report exported and published"
            }
        }

        stage('Delete Scratch Org') {
            steps {
                powershell 'sf org delete scratch --target-org CI_SCRATCH --no-prompt'
                echo "‚úÖ Scratch org deleted after test"
            }
        }
    }

    post {
        success {
            echo "üéâ Pipeline successful ‚Äî all stages passed"
        }
        failure {
            echo "‚ùå Pipeline failed ‚Äî check logs above"
        }
        always {
            powershell 'sf org logout --target-org DevHub --no-prompt || echo "Logout failed or already done"'
            echo "üëã Logged out from Dev Hub"
        }
    }
}



