pipeline {
    agent any

    environment {
        PATH = "C:\\Users\\Rajat Singh\\AppData\\Roaming\\npm;${env.PATH}"

        // Secure Jenkins credentials
        HUB_ORG_DH                   = credentials('HUB_ORG_DH')                   // Dev Hub username/email
        SFDC_HOST_DH                 = credentials('SFDC_HOST_DH')                 // e.g., https://login.salesforce.com
        CONNECTED_APP_CONSUMER_KEY_DH = credentials('CONNECTED_APP_CONSUMER_KEY_DH') // Connected App consumer key
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "CODE CHECKED OUT FROM GITHUB - BRANCH: ${env.BRANCH_NAME}"
            }
        }

        stage('Login to Dev Hub') {
            steps {
                withCredentials([file(credentialsId: 'sfdc-jwt-key', variable: 'key')]) {
                    bat """
                        sf org login jwt ^
                          --client-id %CONNECTED_APP_CONSUMER_KEY_DH% ^
                          --username %HUB_ORG_DH% ^
                          --jwt-key-file "%key%" ^
                          --instance-url %SFDC_HOST_DH% ^
                          --alias DevHub
                    """
                    bat 'sf config set target-org DevHub --global'
                    echo "DEV HUB LOGIN SUCCESSFUL - ALIAS SET: DevHub"
                }
            }
        }

        stage('Create Scratch Org') {
            steps {
                bat 'sf org create scratch --definition-file config/project-scratch-def.json --alias CI_SCRATCH --set-default --duration-days 1 --wait 10'
                echo "SCRATCH ORG CREATED SUCCESSFULLY - ALIAS: CI_SCRATCH"
            }
        }

        stage('Deploy Code to Scratch Org') {
            steps {
                bat 'sf project deploy start --manifest manifest/package.xml --target-org CI_SCRATCH --wait 30'
                echo "DEPLOYMENT SUCCESSFUL TO SCRATCH ORG"
            }
        }

        stage('Run Apex Unit Tests (Human Output)') {
            steps {
                bat 'sf apex run test --target-org CI_SCRATCH --result-format human --code-coverage --wait 10 --output-dir test-results'
                echo "UNIT TESTS EXECUTED - SEE test-results DIRECTORY"
            }
        }

        stage('Export Test Report (JUnit Format)') {
            steps {
                bat 'sf apex run test --target-org CI_SCRATCH --result-format junit --code-coverage --wait 10 --output-dir test-results'
                junit 'test-results/test-result-*.xml'
                echo "TEST RESULTS PUBLISHED IN JENKINS"
            }
        }

        stage('Delete Scratch Org') {
            steps {
                bat 'sf org delete scratch --target-org CI_SCRATCH --no-prompt'
                echo "SCRATCH ORG CLEANUP COMPLETED"
            }
        }
    }

    post {
        success {
            echo "PIPELINE SUCCESSFUL: CODE DEPLOYED, TESTED, AND CLEANED UP"
        }
        failure {
            echo "PIPELINE FAILED - CHECK STAGE LOGS ABOVE"
        }
        always {
            bat 'sf org logout --target-org DevHub --no-prompt || true'
            echo "LOGGED OUT FROM DEV HUB"
        }
    }
}


