pipeline {
    agent any

    environment {
        PATH = "C:\\Users\\Rajat Singh\\AppData\\Roaming\\npm;${env.PATH}"

        // Secure Jenkins credentials
        HUB_ORG_DH                  = credentials('HUB_ORG_DH')                  // Dev Hub username/email
        SFDC_HOST_DH                = credentials('SFDC_HOST_DH')                // e.g., https://login.salesforce.com
        CONNECTED_APP_CONSUMER_KEY_DH = credentials('CONNECTED_APP_CONSUMER_KEY_DH') // Connected App consumer key
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "‚úÖ CODE GITHUB SE AA GAYA ‚Äî BRANCH: ${env.BRANCH_NAME}"
            }
        }

        stage('Login to Dev Hub') {
            steps {
                withCredentials([file(credentialsId: 'sfdc-jwt-key', variable: 'key')]) {
                    bat """
                        sf org login jwt ^
                          --client-id %CONNECTED_APP_CONSUMER_KEY_DH% ^
                          --username %HUB_ORG_DH% ^
                          --jwt-key-file "%key%" ^
                          --instance-url %SFDC_HOST_DH% ^
                          --alias DevHub
                    """
                    bat 'sf config set target-org DevHub --global'
                    echo "üîê DEV HUB LOGIN SUCCESS ‚Äî ALIAS SET: DevHub"
                }
            }
        }

        stage('Create Scratch Org') {
            steps {
                bat 'sf org create scratch --definition-file config/project-scratch-def.json --alias CI_SCRATCH --set-default --duration-days 1 --wait 10'
                echo "üß± SCRATCH ORG CREATED SUCCESSFULLY ‚Äî ALIAS: CI_SCRATCH"
            }
        }

        stage('Push / Deploy Code to Scratch Org') {
            steps {
                bat 'sf project deploy start --manifest manifest/package.xml --target-org CI_SCRATCH --wait 30'
                echo "üöÄ DEPLOYMENT SUCCESSFUL TO SCRATCH ORG"
            }
        }

        stage('Run Apex Unit Tests') {
            steps {
                bat 'sf apex run test --target-org CI_SCRATCH --result-format human --code-coverage --wait 10 --output-dir test-results'
                echo "üß™ UNIT TESTS EXECUTED ‚Äî CHECK test-results/ FOR REPORT"
            }
        }

        stage('Export Test Report') {
            steps {
                bat 'sf apex run test --target-org CI_SCRATCH --result-format junit --code-coverage --wait 10 --output-dir test-results'
                junit 'test-results/test-result-*.xml'
                echo "üìä TEST RESULTS PUBLISHED IN JENKINS UI"
            }
        }

        stage('Delete Scratch Org') {
            steps {
                bat 'sf org delete scratch --target-org CI_SCRATCH --no-prompt'
                echo "üßπ SCRATCH ORG CLEANUP DONE"
            }
        }
    }

    post {
        success {
            echo "üéâ RAJAT‚ÄôS CI/CD PIPELINE SUCCESS: CODE ‚úÖ TEST ‚úÖ CLEANUP ‚úÖ"
        }
        failure {
            echo "‚ùå PIPELINE FAILED ‚Äî CHECK LOGS ABOVE FOR ERRORS"
        }
        always {
            bat 'sf org logout --target-org DevHub --no-prompt || true'
            echo "üîí LOGGED OUT FROM DEV HUB"
        }
    }
}

